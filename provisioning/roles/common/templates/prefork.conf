{%- if php_memory_limit is undefined -%}
    {% set php_memory_limit = calc_php_memory_limit.stdout %}
{%- endif -%}
{%- if reserved_memory_mysql is undefined -%}
    {% set reserved_memory_mysql = 512 if ansible_memtotal_mb >= 2048 else 320 %}
{%- endif -%}
{%- if reserved_memory_system is undefined -%}
    {% set reserved_memory_system = 512 if ansible_memtotal_mb >= 2048 else ((ansible_memtotal_mb/4) | round) %}
{%- endif -%}
{%- if apache_start_servers is undefined -%}
    {% set apache_start_servers = 5 if ansible_memtotal_mb >= 2048 else 2 %}
{%- endif -%}
{%- if apache_min_spare_servers is undefined -%}
    {% set apache_min_spare_servers = 5 if ansible_memtotal_mb >= 2048 else 2 %}
{%- endif -%}
{%- if apache_max_spare_servers is undefined -%}
    {% set apache_max_spare_servers = 10 if ansible_memtotal_mb >= 2048 else 3 %}
{%- endif -%}
{%- if apache_max_requests_per_child is undefined -%}
    {% set apache_max_requests_per_child = 1000 %}
{%- endif -%}
{%- if apache_max_clients is undefined -%}
    {% set apache_max_clients = ((ansible_memtotal_mb - reserved_memory_system - reserved_memory_mysql) / (php_memory_limit|int/2)) | round(method='ceil') | int %}
    {%- if ansible_processor_vcpus > apache_max_clients -%}
        {% set apache_max_clients = ansible_processor_vcpus %}
    {%- endif -%}
{%- endif -%}

# prefork MPM
# StartServers: number of server processes to start
# MinSpareServers: minimum number of server processes which are kept spare
# MaxSpareServers: maximum number of server processes which are kept spare
# MaxClients: maximum number of server processes allowed to start
# MaxRequestsPerChild: maximum number of requests a server process serves
<IfModule mpm_prefork_module>
    StartServers          {{ apache_start_servers }}
    MinSpareServers       {{ apache_min_spare_servers }}
    MaxSpareServers       {{ apache_max_spare_servers }}
    MaxClients            {{ apache_max_clients }}
    ServerLimit           {{ apache_max_clients }}
    MaxRequestsPerChild   {{ apache_max_requests_per_child }}
</IfModule>
